!function(){"use strict";!function(){if(window.__CHAT_WIDGET_LOADED__)return;window.__CHAT_WIDGET_LOADED__=!0;const e=document.currentScript;const t=function(){if(e?.src)try{return new URL(e.src,document.baseURI).href.replace(/\/widget\.js(\?.*)?$/,"")}catch{return""}return""}();function n(e){if(!e)return"";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:"))return e;if(t){if(e.startsWith("/"))return t+e;const n=e.startsWith("./")?e.slice(2):e;return t+"/"+n}try{return new URL(e,document.baseURI).href}catch{return e}}const a={apiEndpoint:e?.dataset.apiEndpoint||"/api/v1/rag/ask/stream_chat",widgetUrl:e?.dataset.widgetUrl||(t?t+"/index.html":"./index.html"),primaryColor:e?.dataset.primaryColor||"#E84967",headerBgColor:e?.dataset.headerBgColor||"",headerTextColor:e?.dataset.headerTextColor||"#ffffff",bubbleBgColor:e?.dataset.bubbleBgColor||"",position:e?.dataset.position||"bottom-right",bubbleSize:e?.dataset.bubbleSize||"medium",headerTitle:e?.dataset.headerTitle||"屏基AI小天使",headerSubtitle:e?.dataset.headerSubtitle||"請問有什麼可以協助您？",welcomeMessage:e?.dataset.welcomeMessage||"您好，我是屏基AI小天使，請問有什麼可以協助您？",inputPlaceholder:e?.dataset.inputPlaceholder||"輸入訊息...",headerIcon:e?.dataset.headerIcon||"",bubbleIcon:e?.dataset.bubbleIcon||"",quickReplies:function(e,t){if(!e)return t;try{return JSON.parse(e)}catch{return t}}(e?.dataset.quickReplies,[]),quickRepliesStyle:e?.dataset.quickRepliesStyle||"outline",autoOpen:"true"===e?.dataset.autoOpen,autoOpenDelay:parseInt(e?.dataset.autoOpenDelay,10)||3e3};let i=!1,o=!1,r=null,d=null,s=null,c=0;const l=`\n    #chat-widget-container {\n      position: fixed;\n      bottom: 20px;\n      ${"bottom-left"===a.position?"left: 20px;":"right: 20px;"}\n      z-index: 2147483647;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    }\n\n    #chat-widget-bubble {\n      width: ${"small"===a.bubbleSize?"48px":"large"===a.bubbleSize?"64px":"56px"};\n      height: ${"small"===a.bubbleSize?"48px":"large"===a.bubbleSize?"64px":"56px"};\n      border-radius: 50%;\n      background-color: ${a.bubbleBgColor||a.primaryColor};\n      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: transform 0.2s ease, box-shadow 0.2s ease;\n      overflow: hidden;\n    }\n\n    #chat-widget-bubble:hover {\n      transform: scale(1.08);\n      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);\n    }\n\n    #chat-widget-bubble svg {\n      width: ${"small"===a.bubbleSize?"24px":"large"===a.bubbleSize?"32px":"28px"};\n      height: ${"small"===a.bubbleSize?"24px":"large"===a.bubbleSize?"32px":"28px"};\n      fill: white;\n    }\n\n    #chat-widget-bubble img {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n    }\n\n    #chat-widget-bubble-badge {\n      position: absolute;\n      top: -4px;\n      right: -4px;\n      min-width: 20px;\n      height: 20px;\n      padding: 0 6px;\n      border-radius: 10px;\n      background-color: #ef4444;\n      color: white;\n      font-size: 12px;\n      font-weight: 600;\n      display: none;\n      align-items: center;\n      justify-content: center;\n    }\n\n    #chat-widget-bubble-badge.show {\n      display: flex;\n    }\n\n    #chat-widget-frame-container {\n      position: absolute;\n      bottom: 70px;\n      ${"bottom-left"===a.position?"left: 0;":"right: 0;"}\n      width: 380px;\n      height: 600px;\n      max-height: calc(100vh - 100px);\n      border-radius: 16px;\n      overflow: hidden;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\n      opacity: 0;\n      transform: translateY(20px) scale(0.95);\n      pointer-events: none;\n      transition: opacity 0.2s ease, transform 0.2s ease;\n    }\n\n    #chat-widget-frame-container.open {\n      opacity: 1;\n      transform: translateY(0) scale(1);\n      pointer-events: auto;\n    }\n\n    #chat-widget-frame-container.expanded {\n      position: fixed;\n      inset: 0;\n      width: 100%;\n      height: 100%;\n      max-height: 100%;\n      border-radius: 0;\n      bottom: 0;\n    }\n\n    #chat-widget-iframe {\n      width: 100%;\n      height: 100%;\n      border: none;\n      background: white;\n    }\n\n    /* 手機響應式 */\n    @media (max-width: 480px) {\n      #chat-widget-frame-container {\n        position: fixed;\n        inset: 0;\n        width: 100%;\n        height: 100%;\n        max-height: 100%;\n        border-radius: 0;\n        bottom: 0;\n      }\n\n      #chat-widget-bubble {\n        bottom: 16px;\n        ${"bottom-left"===a.position?"left: 16px;":"right: 16px;"}\n      }\n    }\n  `;function h(){const e=document.createElement("style");e.textContent=l,document.head.appendChild(e),r=document.createElement("div"),r.id="chat-widget-container",d=document.createElement("div"),d.id="chat-widget-bubble";const t=n(a.bubbleIcon),i=t?`<img src="${t}" alt="Chat" />`:'<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>\n          <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>\n        </svg>';d.innerHTML=`\n      ${i}\n      <span id="chat-widget-bubble-badge">0</span>\n    `,d.addEventListener("click",b);const o=document.createElement("div");o.id="chat-widget-frame-container",s=document.createElement("iframe"),s.id="chat-widget-iframe",s.src=a.widgetUrl,s.title=a.headerTitle,s.allow="microphone",o.appendChild(s),r.appendChild(d),r.appendChild(o),document.body.appendChild(r),window.addEventListener("message",p),a.autoOpen&&setTimeout(g,a.autoOpenDelay)}function p(e){const t=e.data;if(t&&"object"==typeof t&&"chat-widget-iframe"===t.source)switch(t.type){case"READY":u();break;case"CLOSE":m();break;case"NEW_MESSAGE":!i&&t.payload?.unreadCount>0&&(c=t.payload.unreadCount,w());break;case"RESIZE":break;case"TOGGLE_EXPAND":!function(){o=!o;const e=document.getElementById("chat-widget-frame-container");e&&(o?e.classList.add("expanded"):e.classList.remove("expanded"));!function(){if(!s?.contentWindow)return;s.contentWindow.postMessage({source:"chat-widget-loader",type:"EXPANDED_STATE",payload:{isExpanded:o}},"*")}()}()}}function u(){s?.contentWindow&&s.contentWindow.postMessage({source:"chat-widget-loader",type:"INIT_CONFIG",payload:{apiEndpoint:a.apiEndpoint,primaryColor:a.primaryColor,headerBgColor:a.headerBgColor||a.primaryColor,headerTextColor:a.headerTextColor,headerTitle:a.headerTitle,headerSubtitle:a.headerSubtitle,headerIcon:n(a.headerIcon),welcomeMessage:a.welcomeMessage,inputPlaceholder:a.inputPlaceholder,quickReplies:a.quickReplies,quickRepliesStyle:a.quickRepliesStyle}},"*")}function b(){i?m():g()}function g(){i=!0,c=0,w();const e=document.getElementById("chat-widget-frame-container");e&&e.classList.add("open"),f(!0)}function m(){i=!1;const e=document.getElementById("chat-widget-frame-container");e&&e.classList.remove("open"),f(!1)}function f(e){if(!d)return;const t=d.querySelector("svg");t&&(t.innerHTML=e?'\n        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n      ':'\n        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>\n        <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>\n      ')}function w(){const e=document.getElementById("chat-widget-bubble-badge");e&&(c>0?(e.textContent=c>99?"99+":c,e.classList.add("show")):e.classList.remove("show"))}window.ChatWidget={open:g,close:m,toggle:b,updateConfig:function(e){Object.assign(a,e),u()}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h()}()}();
