<div class="flex justify-center px-4 py-6">
  <div
    class="w-full max-w-7xl rounded-xl border border-slate-800 bg-slate-900/70 shadow-xl backdrop-blur flex flex-col h-[calc(100vh-5.5rem)]"
  >
    <header class="border-b border-slate-800 px-4 py-3 flex items-center justify-between">
      <div>
        <h1 class="text-sm font-semibold text-slate-50">
          {{ pageTitle }}
        </h1>
        <p class="mt-1 text-xs text-slate-400">
          é€™å€‹é é¢æœƒä¸²æ¥
          <span class="rounded bg-slate-800 px-1.5 py-0.5 font-mono text-[11px] text-slate-200">
            {{ apiPath }}
          </span>
          é€²è¡Œ SSE ä¸²æµæ¸¬è©¦ã€‚
        </p>
      </div>
      <div class="flex items-center gap-2 text-xs text-slate-400">
        <span
          class="inline-flex h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"
        ></span>
        <span>ä¸²æµå·²å•Ÿç”¨</span>
      </div>
    </header>

    <section class="flex-1 overflow-hidden flex flex-col">
      <div #messagesContainer class="flex-1 overflow-y-auto px-4 py-3 space-y-3">
        @if (messages().length === 0) {
          <div
            class="mt-6 rounded-lg border border-dashed border-slate-700 bg-slate-900/60 px-4 py-3 text-sm text-slate-400"
          >
            <p class="mb-1 font-medium text-slate-300">
              æ­¡è¿ä½¿ç”¨ RAG ä¸²æµ Chatbot ğŸ§
            </p>
            <p>éš¨ä¾¿å•ä¸€å¥è©±ï¼Œçœ‹çœ‹ä¸²æµå›ç­”èˆ‡ reasoning æŒ‡ç¤ºæ•ˆæœã€‚</p>
            <ul class="mt-2 list-disc pl-5 text-xs">
              <li>ä¸‹æ–¹è¼¸å…¥æ¡†è¼¸å…¥å•é¡Œå¾ŒæŒ‰ Enter æˆ–é€å‡ºã€‚</li>
              <li>åœ¨å›æ‡‰æœŸé–“æœƒé¡¯ç¤ºã€Œæ­£åœ¨æ€è€ƒã€çš„æç¤ºã€‚</li>
              <li>å›ç­”å…§å®¹æœƒéš¨è‘— SSE äº‹ä»¶é€æ­¥ä¸²æµé¡¯ç¤ºã€‚</li>
            </ul>
          </div>
        }

        @for (message of messages(); track message.id) {
          <div class="space-y-1" [attr.id]="'message-' + message.id">
            <div class="flex" [class.justify-end]="message.role === 'user'">
              <div
                class="max-w-[80%] rounded-2xl px-3 py-2 text-sm shadow"
                [class.bg-indigo-600]="message.role === 'user'"
                [class.text-white]="message.role === 'user'"
                [class.bg-slate-800]="message.role === 'assistant'"
                [class.text-slate-50]="message.role === 'assistant'"
              >
                <div class="mb-0.5 text-[11px] font-medium uppercase tracking-wide text-slate-300"
                     *ngIf="message.role === 'assistant'">
                  åŠ©æ‰‹
                </div>
                <div class="mb-0.5 text-[11px] font-medium uppercase tracking-wide text-slate-100"
                     *ngIf="message.role === 'user'">
                  ä½¿ç”¨è€…
                </div>
                @if (message.role === 'assistant') {
                  <div class="leading-relaxed">
                    @if (!message.content && (message.details?.isStreaming || isLoading())) {
                      <div
                        class="inline-flex items-center gap-2 rounded-full bg-slate-900/80 px-3 py-1.5 text-[11px] text-slate-300"
                      >
                        <span class="typing-indicator">
                          <span class="typing-indicator-dot"></span>
                          <span class="typing-indicator-dot"></span>
                          <span class="typing-indicator-dot"></span>
                        </span>
                        <span>åŠ©æ‰‹æ­£åœ¨è¼¸å…¥ä¸­...</span>
                      </div>
                    } @else {
                      <div class="markdown-body">
                        <markdown
                          [data]="normalizeMarkdown(message.content) || '...'"
                        ></markdown>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="whitespace-pre-wrap leading-relaxed">
                    {{ message.content }}
                  </div>
                }
              </div>
            </div>

            <!-- åŠ©æ‰‹å›æ‡‰å·¥å…·åˆ— -->
            @if (message.role === 'assistant' && message.content && !message.details?.isStreaming) {
              <div class="flex items-center gap-1 mt-2 ml-1 max-w-[80%]">
                <!-- è¤‡è£½æŒ‰éˆ• -->
                <button
                  type="button"
                  class="inline-flex items-center justify-center w-8 h-8 rounded-md text-slate-400 hover:text-slate-200 hover:bg-slate-800 transition"
                  (click)="onCopyAnswer(message.id)"
                  [title]="copiedMessageId === message.id ? 'å·²è¤‡è£½ï¼' : 'è¤‡è£½å›ç­”'"
                >
                  @if (copiedMessageId === message.id) {
                    <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  } @else {
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                  }
                </button>

                <!-- é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
                <button
                  type="button"
                  class="inline-flex items-center justify-center w-8 h-8 rounded-md text-slate-400 hover:text-slate-200 hover:bg-slate-800 transition disabled:opacity-50 disabled:cursor-not-allowed"
                  (click)="onRegenerate(message.id)"
                  [disabled]="isLoading()"
                  title="é‡æ–°ç”Ÿæˆå›ç­”"
                >
                  <svg class="w-4 h-4" [class.animate-spin]="isLoading()" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                </button>

                <!-- åˆ†éš”ç·š -->
                <div class="w-px h-4 bg-slate-700 mx-1"></div>

                <!-- è®š/å€’è®šæŒ‰éˆ•ï¼ˆéœ€è¦ traceIdï¼‰ -->
                @if (message.details?.traceId) {
                  <!-- è®šæŒ‰éˆ• -->
                  <button
                    type="button"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-md transition"
                    [class.bg-emerald-600]="message.details?.userFeedback === 'up'"
                    [class.text-white]="message.details?.userFeedback === 'up'"
                    [class.text-slate-400]="message.details?.userFeedback !== 'up'"
                    [class.hover:text-emerald-400]="message.details?.userFeedback !== 'up'"
                    [class.hover:bg-slate-800]="message.details?.userFeedback !== 'up'"
                    (click)="onFeedback(message.id, 'up')"
                    [disabled]="feedbackLoading()"
                    title="é€™å€‹å›ç­”å¾ˆæœ‰å¹«åŠ©"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                    </svg>
                  </button>

                  <!-- å€’è®šæŒ‰éˆ• -->
                  <button
                    type="button"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-md transition"
                    [class.bg-red-600]="message.details?.userFeedback === 'down'"
                    [class.text-white]="message.details?.userFeedback === 'down'"
                    [class.text-slate-400]="message.details?.userFeedback !== 'down'"
                    [class.hover:text-red-400]="message.details?.userFeedback !== 'down'"
                    [class.hover:bg-slate-800]="message.details?.userFeedback !== 'down'"
                    (click)="onFeedback(message.id, 'down')"
                    [disabled]="feedbackLoading()"
                    title="é€™å€‹å›ç­”éœ€è¦æ”¹é€²"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m4-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
                    </svg>
                  </button>
                }
              </div>
            }

            @if (message.role === 'assistant' && message.details) {
              <div class="max-w-[80%]">
                <button
                  type="button"
                  class="inline-flex items-center gap-1 text-[11px] text-slate-400 hover:text-slate-200 transition"
                  (click)="toggleDetails(message.id)"
                >
                  <span
                    class="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-500 text-[9px]"
                  >
                    {{ message.details.expanded ? 'ï¼' : 'ï¼‹' }}
                  </span>
                  <span>
                    {{ message.details.expanded ? 'éš±è—æ¨ç†èˆ‡éšæ®µç´°ç¯€' : 'é¡¯ç¤ºæ¨ç†èˆ‡éšæ®µç´°ç¯€' }}
                  </span>
                  @if (message.details.isStreaming) {
                    <span class="ml-1 inline-flex items-center gap-1 text-amber-300">
                      <span class="h-1.5 w-1.5 rounded-full bg-amber-400 animate-pulse"></span>
                      ä¸²æµä¸­
                    </span>
                  }
                </button>

                @if (message.details.expanded) {
                  <div
                    class="mt-1 rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-[11px] text-slate-300 space-y-2"
                  >
                    @if (message.details.tokenUsage || message.details.durationMs !== undefined) {
                      <div class="flex flex-wrap items-center gap-2 text-[11px]">
                        @if (message.details.tokenUsage) {
                          <div
                            class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/80 px-2 py-1"
                          >
                            <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
                            <span>Tokens: {{ message.details.tokenUsage.totalTokens ?? 'â€”' }}</span>
                            <span class="text-slate-500">
                              (in: {{ message.details.tokenUsage.inputTokens ?? 'â€”' }},
                              out: {{ message.details.tokenUsage.outputTokens ?? 'â€”' }})
                            </span>
                          </div>
                        }
                        @if (message.details.durationMs !== undefined) {
                          <div
                            class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/80 px-2 py-1"
                          >
                            <span class="h-1.5 w-1.5 rounded-full bg-sky-400"></span>
                            <span>
                              è€—æ™‚ï¼ˆSSEï¼‰ï¼šç´„ {{ message.details.durationMs | number: '1.0-0' }} ms
                            </span>
                          </div>
                        }
                      </div>
                    }

                    @if (message.details.statusMessages.length) {
                      <div>
                        <div class="mb-1 text-[11px] font-semibold text-slate-200">
                          éšæ®µç‹€æ…‹
                        </div>
                        <div class="mt-1">
                          <ul class="space-y-1 border-l border-slate-700 pl-3">
                            @for (s of message.details.statusMessages; track $index) {
                              <li class="relative pl-2">
                                <span
                                  class="absolute -left-2 top-1.5 h-2 w-2 rounded-full border border-slate-300 bg-slate-900"
                                ></span>
                                <span>{{ s }}</span>
                              </li>
                            }
                          </ul>
                        </div>
                      </div>
                    }

                    @if (message.details.planning) {
                      <div>
                        <div class="mb-1 text-[11px] font-semibold text-sky-300">
                          è¦åŠƒ / Query é‡å¯«
                        </div>
                        <pre
                          class="whitespace-pre-wrap rounded bg-slate-900/80 px-2 py-1 font-mono text-[11px] text-slate-200"
                        >{{ message.details.planning }}</pre>
                      </div>
                    }

                    @if (message.details.retrieval) {
                      <div>
                        <div class="mb-1 text-[11px] font-semibold text-emerald-300">
                          æª¢ç´¢éšæ®µ
                        </div>
                        <pre
                          class="whitespace-pre-wrap rounded bg-slate-900/80 px-2 py-1 font-mono text-[11px] text-slate-200"
                        >{{ message.details.retrieval }}</pre>
                      </div>
                    }

                    @if (message.details.reasoning) {
                      <div>
                        <div class="mb-1 text-[11px] font-semibold text-amber-300">
                          Reasoning æ€è€ƒéç¨‹
                        </div>
                    <div
                          class="rounded bg-slate-900/80 px-2 py-1 text-[11px] text-slate-200 markdown-body"
                        >
                          <markdown [data]="normalizeMarkdown(message.details.reasoning)"></markdown>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }

        @if (isThinking()) {
          <div class="flex gap-2 items-center text-xs text-amber-300 mt-2">
            <span class="h-2 w-2 rounded-full bg-amber-400 animate-pulse"></span>
            <span>ğŸ¤” æ¨¡å‹æ­£åœ¨æ·±åº¦æ€è€ƒï¼ˆreasoning ä¸­ï¼‰...</span>
          </div>
        }

        @if (errorMessage()) {
          <div class="mt-2 rounded-md border border-red-500/60 bg-red-950/60 px-3 py-2 text-xs text-red-200">
            {{ errorMessage() }}
          </div>
        }
      </div>

      <form
        class="border-t border-slate-800 px-4 py-3 flex flex-col gap-2 bg-slate-950/70"
        (submit)="onSubmit($event)"
      >
        <div class="flex items-end gap-2">
          <div class="flex-1">
            <label class="mb-1 block text-xs font-medium text-slate-400">
              æå•å…§å®¹
            </label>
            <textarea
              class="block w-full resize-none rounded-lg border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 outline-none ring-0 transition placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
              rows="2"
              [(ngModel)]="inputValue"
              name="question"
              (keydown)="onTextareaKeydown($event)"
              [disabled]="isLoading()"
              placeholder="ä¾‹å¦‚ï¼šè«‹èªªæ˜è¨‚é–±æ–¹æ¡ˆçš„å·®ç•°ï¼Ÿ"
            ></textarea>
          </div>
          <button
            type="submit"
            class="inline-flex h-10 shrink-0 items-center justify-center rounded-lg bg-indigo-600 px-4 text-sm font-medium text-white shadow hover:bg-indigo-500 disabled:cursor-not-allowed disabled:bg-slate-700 disabled:text-slate-300"
            [disabled]="!canSend()"
          >
            @if (isLoading()) {
              <span class="mr-2 h-3 w-3 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
              ä¸²æµä¸­...
            } @else {
              é€å‡º
            }
          </button>
        </div>
        <div
          class="flex flex-wrap items-center gap-3 text-[11px] text-slate-300"
        >
          <div class="flex items-center gap-1">
            <span class="text-slate-400">Model</span>
            <select
              class="h-7 rounded-md border border-slate-700 bg-slate-900/80 px-2 text-[11px] text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              [(ngModel)]="selectedModel"
              name="model"
              [disabled]="isLoading()"
            >
              <option [ngValue]="''">ï¼ˆä½¿ç”¨ç³»çµ±é è¨­ï¼‰</option>
              <option
                *ngFor="let m of modelOptions"
                [ngValue]="m"
              >
                {{ m }}
              </option>
            </select>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-slate-400">æ€è€ƒå±¤ç´š(AFS ä¸æ”¯æ´)</span>
            <select
              class="h-7 rounded-md border border-slate-700 bg-slate-900/80 px-2 text-[11px] text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              [(ngModel)]="selectedReasoningEffort"
              name="reasoningEffort"
              [disabled]="isLoading()"
            >
              <option
                *ngFor="let level of reasoningEffortOptions"
                [ngValue]="level"
              >
                {{ level }}
              </option>
            </select>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-slate-400">top_k</span>
            <input
              type="number"
              min="1"
              max="10"
              class="h-7 w-16 rounded-md border border-slate-700 bg-slate-900/80 px-2 text-[11px] text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              [(ngModel)]="topK"
              name="topK"
              [disabled]="isLoading()"
            />
          </div>
          <label class="inline-flex items-center gap-2 text-slate-400">
            <input
              type="checkbox"
              class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-indigo-500 focus:ring-indigo-500"
              [(ngModel)]="conversationSummaryEnabled"
              name="conversationSummaryEnabled"
              [disabled]="isLoading()"
              (ngModelChange)="onConversationSummaryToggle($event)"
            />
            <span>å°è©±æ‘˜è¦è¨˜æ†¶</span>
          </label>
        </div>
        <p class="text-[11px] text-slate-500">
          æœ¬é é¢åƒ…ä¾›æ¸¬è©¦ä¸²æ¥
          <span class="font-mono text-slate-300">/api/v1/rag/ask/stream</span>
          æˆ–
          <span class="font-mono text-slate-300">/api/v1/rag/ask/stream_chat</span>
          çš„ SSE å›æ‡‰ã€‚
        </p>
      </form>
    </section>
  </div>
</div>

<!-- Lightbox åœ–ç‰‡æ”¾å¤§å½ˆçª— -->
@if (lightboxImageSrc) {
  <div
    class="image-lightbox-overlay"
    (click)="closeLightbox()"
    role="dialog"
    aria-modal="true"
    aria-label="æ”¾å¤§åœ–ç‰‡"
  >
    <button
      type="button"
      class="image-lightbox-close"
      (click)="closeLightbox(); $event.stopPropagation()"
      aria-label="é—œé–‰"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <img
      [src]="lightboxImageSrc"
      alt="æ”¾å¤§æª¢è¦–"
      (click)="$event.stopPropagation()"
    />
  </div>
}

<!-- å€’è®šå›é¥‹å½ˆçª— -->
@if (showFeedbackPopup) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
    <div class="w-full max-w-md rounded-xl border border-slate-700 bg-slate-900 p-5 shadow-2xl">
      <h3 class="text-base font-semibold text-slate-100 mb-3">
        è«‹å‘Šè¨´æˆ‘å€‘å“ªè£¡éœ€è¦æ”¹é€²
      </h3>
      <p class="text-sm text-slate-400 mb-4">
        æ‚¨çš„æ„è¦‹å°‡å¹«åŠ©æˆ‘å€‘æå‡å›ç­”å“è³ªã€‚ï¼ˆé¸å¡«ï¼‰
      </p>
      <textarea
        class="block w-full resize-none rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-50 outline-none ring-0 transition placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
        rows="4"
        [(ngModel)]="feedbackComment"
        placeholder="ä¾‹å¦‚ï¼šå›ç­”ä¸å¤ å®Œæ•´ã€è³‡è¨Šæœ‰èª¤ã€æ ¼å¼é›£ä»¥é–±è®€..."
      ></textarea>
      <div class="mt-4 flex justify-end gap-2">
        <button
          type="button"
          class="inline-flex items-center justify-center rounded-lg border border-slate-600 bg-slate-800 px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 transition"
          (click)="onCancelFeedbackPopup()"
        >
          å–æ¶ˆ
        </button>
        <button
          type="button"
          class="inline-flex items-center justify-center rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="onConfirmDownvote()"
          [disabled]="feedbackLoading()"
        >
          @if (feedbackLoading()) {
            <span class="mr-2 h-3 w-3 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
            é€å‡ºä¸­...
          } @else {
            ç¢ºèªé€å‡º
          }
        </button>
      </div>
    </div>
  </div>
}


