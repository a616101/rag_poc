services:
  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: chatbot-rag-qdrant_ptch
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_ptch_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 sh -c 'cat < /dev/null > /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Development server with hot reload
  app-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: chatbot-rag-dev
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
      - ./logs:/app/logs
      - ./rag_test_data:/app/rag_test_data
      - ./huggingface:/root/.cache/huggingface
    env_file:
      - .env
    environment:
      - RELOAD=True
      - LOG_TO_CONSOLE=True
      - LOG_TO_FILE=True
      - DEBUG=True
      - QDRANT_URL=http://qdrant:6333
      - PYTHONPATH=/app/src
    command: python -m chatbot_rag.cli dev
    depends_on:
      - qdrant
    networks:
      - chatbot-network
    profiles:
      - development

  # Production-like server
  app-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: chatbot-rag-prod
    ports:
      - "8000:8000"
    volumes:
      - ./logs:/app/logs
      - ./rag_test_data:/app/rag_test_data
    env_file:
      - .env
    environment:
      - RELOAD=False
      - LOG_TO_CONSOLE=True
      - LOG_TO_FILE=True
      - DEBUG=False
      - WORKERS=8
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION_NAME=ptch_documents
    # 使用 uvicorn 直接啟動（production image 沒有 uv）
    command: ["uvicorn", "chatbot_rag.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "8"]
    depends_on:
      - qdrant
    networks:
      - chatbot-network
    profiles:
      - production

  # Frontend Angular 應用（Nginx 提供靜態檔案 + 反向代理 /api 到 app-prod）
  frontend:
    build:
      context: ./frontend/chatbot-ui
      dockerfile: Dockerfile
    container_name: chatbot-rag-frontend
    ports:
      - "4201:80"
    depends_on:
      - app-prod
    networks:
      - chatbot-network
    profiles:
      - production

  # Chat Widget 開發模式（熱更新）
  chat-widget-dev:
    build:
      context: ./frontend/chat-widget
      dockerfile: Dockerfile.dev
      target: development
    container_name: chatbot-rag-chat-widget-dev
    ports:
      - "4202:5180"
    volumes:
      - ./frontend/chat-widget/src:/app/src
      - ./frontend/chat-widget/public:/app/public
      - ./frontend/chat-widget/loader:/app/loader
      - ./frontend/chat-widget/index.html:/app/index.html
      - ./frontend/chat-widget/vite.config.js:/app/vite.config.js
      - ./frontend/chat-widget/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/chat-widget/postcss.config.js:/app/postcss.config.js
      - ./frontend/chat-widget/svelte.config.js:/app/svelte.config.js
    environment:
      - API_TARGET=http://app-dev:8000
    depends_on:
      - app-dev
    networks:
      - chatbot-network
    profiles:
      - widget-dev

  # Chat Widget 生產模式（Nginx 靜態伺服）
  chat-widget:
    build:
      context: ./frontend/chat-widget
      dockerfile: Dockerfile
      target: development
    container_name: chatbot-rag-chat-widget
    ports:
      - "4203:80"
    depends_on:
      - app-dev
    networks:
      - chatbot-network
    profiles:
      - widget

  # Test runner service
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: chatbot-rag-test
    volumes:
      - ./tests:/app/tests
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_TO_CONSOLE=True
      - LOG_TO_FILE=False
    command: >
      sh -c "
        echo 'Removing existing venv...' &&
        rm -rf .venv &&
        echo 'Installing dependencies with dev packages...' &&
        uv sync --extra dev &&
        echo 'Running tests...' &&
        uv run pytest -v
      "
    networks:
      - chatbot-network
    profiles:
      - test

  # Test runner with coverage
  test-coverage:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: chatbot-rag-test-coverage
    volumes:
      - ./tests:/app/tests
      - ./htmlcov:/app/htmlcov
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_TO_CONSOLE=True
      - LOG_TO_FILE=False
    command: >
      sh -c "
        echo 'Removing existing venv...' &&
        rm -rf .venv &&
        echo 'Installing dependencies with dev packages and coverage...' &&
        uv sync --extra dev &&
        uv add pytest-cov &&
        echo 'Running tests with coverage...' &&
        uv run pytest --cov=src/chatbot_rag --cov-report=html --cov-report=term -v
      "
    networks:
      - chatbot-network
    profiles:
      - test

networks:
  chatbot-network:
    driver: bridge

volumes:
  qdrant_ptch_storage:
    driver: local
