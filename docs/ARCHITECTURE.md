# 系統架構

本文件說明 Chatbot RAG 系統的整體架構設計。

## 架構概覽

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend (Angular)                        │
└──────────────────────────────┬──────────────────────────────────┘
                               │ SSE / HTTP
┌──────────────────────────────▼──────────────────────────────────┐
│                     FastAPI Application                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ Middleware  │  │ API Routes  │  │      Core Config        │  │
│  │ - Logging   │  │ - /rag/*    │  │  - Settings (Pydantic)  │  │
│  │ - Perf Mon  │  │ - /admin/*  │  │  - Logging (Loguru)     │  │
│  │ - CORS      │  │ - /files/*  │  │  - Environment          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────┐
│                     Agentic RAG Layer                            │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │               LangGraph Computational Graph                 │ │
│  │  ┌───────┐  ┌─────────┐  ┌─────────┐  ┌────────────────┐  │ │
│  │  │ Guard │→│ Lang    │→│ Planner │→│ Query Builder  │  │ │
│  │  │       │  │ Normal. │  │         │  │                │  │ │
│  │  └───────┘  └─────────┘  └────┬────┘  └───────┬────────┘  │ │
│  │                               │               │            │ │
│  │  ┌────────────────────────────▼───────────────▼─────────┐ │ │
│  │  │                   Tool Executor                       │ │ │
│  │  │   ┌─────────────────┐   ┌───────────────────────┐    │ │ │
│  │  │   │ retrieve_docs   │   │ get_form_links        │    │ │ │
│  │  │   └─────────────────┘   └───────────────────────┘    │ │ │
│  │  └────────────────────────────┬─────────────────────────┘ │ │
│  │                               │                            │ │
│  │  ┌────────────────────────────▼─────────────────────────┐ │ │
│  │  │ Doc Grader │→│ Response Synth │→│ Telemetry │       │ │ │
│  │  └──────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────┐
│                      Service Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ Document    │  │ Embedding   │  │ Contextual Chunking     │  │
│  │ Service     │  │ Service     │  │ Service                 │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ Retriever   │  │ LLM         │  │ Prompt                  │  │
│  │ Service     │  │ Service     │  │ Service                 │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────┐
│                    External Services                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Qdrant    │  │ LLM API     │  │      Langfuse           │  │
│  │ (Vector DB) │  │ (OpenAI)    │  │   (Observability)       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 核心元件

### 1. FastAPI 應用層

**主要責任：**
- HTTP 請求處理和路由
- 中介軟體管道（日誌、效能監控、CORS）
- 生命週期管理（啟動/關閉）

**關鍵檔案：**
- `main.py` - 應用工廠，配置中介軟體
- `api/routes.py` - 基礎路由
- `api/rag_routes.py` - RAG API 端點
- `api/admin_routes.py` - 管理端點

**設計決策：**
- 使用 `ORJSONResponse` 提升 JSON 序列化效能 (2-3x)
- 三層中介軟體：Request Logging → Performance → CORS
- 每個請求附加唯一 `request_id` 用於分散式追蹤

### 2. Agentic RAG 層

這是系統的**核心創新**，實現複雜的多步智能問答。

**傳統 RAG vs Agentic RAG：**

| 傳統 RAG | Agentic RAG |
|----------|-------------|
| Query → Retrieve → Generate | Query → Plan → Decide → Execute → Grade → Generate |
| 固定流程 | 條件分支、迴圈 |
| 單一檢索 | 多工具協作 |

**LangGraph 計算圖 (9 個節點)：**

```
START
  │
  ▼
┌─────────┐
│  guard  │ ← 輸入檢查（預留擴展）
└────┬────┘
     │
     ▼
┌─────────────────────┐
│ language_normalizer │ ← 語言檢測、問題規範化
└──────────┬──────────┘
           │
           ▼
     ┌───────────┐
     │  planner  │ ← 任務規劃、決定是否檢索
     └─────┬─────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
should_retrieve  no_retrieval
    │             │
    ▼             │
┌───────────────┐ │
│ followup_     │ │
│ transform     │ │ ← 處理跟進問題
└───────┬───────┘ │
        │         │
        ▼         │
┌───────────────┐ │
│ query_builder │ │ ← 重寫檢索查詢
└───────┬───────┘ │
        │         │
        ▼         │
┌───────────────┐ │
│ tool_executor │ │ ← 執行工具（檢索、表單）
└───────┬───────┘ │
        │         │
        ▼         │
┌───────────────┐ │
│ document_     │ │ ← 評分文件相關性
│ grader        │ │
└───────┬───────┘ │
        │         │
        ▼         │
┌───────────────┐ │
│ response_     │◄┘
│ synth         │ ← 生成最終回答
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  telemetry    │ ← 記錄追蹤資料
└───────┬───────┘
        │
        ▼
       END
```

### 3. 服務層

採用**單例模式**，全域共用實例：

| 服務 | 責任 |
|------|------|
| `DocumentService` | 文件載入、分塊、向量化 |
| `EmbeddingService` | 文字向量嵌入 |
| `QdrantService` | 向量資料庫操作 |
| `RetrieverService` | 文件檢索、上下文擴展 |
| `ContextualChunkingService` | 脈絡化分塊 |
| `PromptService` | Langfuse Prompt 管理 |

**服務依賴關係：**

```
RetrieverService
    ├── EmbeddingService
    └── QdrantService

DocumentService
    ├── EmbeddingService
    ├── QdrantService
    └── ContextualChunkingService
```

### 4. LLM 層

**關鍵元件：**
- `factory.py` - LLM 工廠函式
- `responses_chat_model.py` - OpenAI Responses API 支援
- `responses_accumulator.py` - 串流回應累積器
- `graph_nodes.py` - LangGraph 狀態定義

**支援特性：**
- OpenAI Chat Completion API
- OpenAI Responses API (o1, o3 模型)
- 串流推理 (reasoning_effort, reasoning_summary)

## 資料流程

### 文件向量化流程

```
Markdown 文件 (含 YAML frontmatter)
         │
         ▼
┌─────────────────────────────────┐
│ DocumentService                  │
│ ├─ 解析 frontmatter (metadata)   │
│ └─ 分塊 (RecursiveCharSplitter)  │
│    ├─ chunk_size: 500           │
│    └─ chunk_overlap: 50         │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│ ContextualChunkingService        │
│ ├─ Level 1: 結構化脈絡           │
│ │  (frontmatter + section)       │
│ └─ Level 2: 語義脈絡 (LLM)       │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│ EmbeddingService                 │
│ └─ 生成向量 (768 維)             │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│ QdrantService                    │
│ └─ 儲存向量 + metadata           │
└─────────────────────────────────┘
```

### 查詢處理流程

```
用戶問題
    │
    ▼
┌─────────────────────────────────┐
│ Guard + Language Normalizer      │
│ └─ 驗證、語言檢測、規範化         │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Planner                          │
│ ├─ 分析意圖                      │
│ └─ 決定 should_retrieve          │
└─────────────────────────────────┘
    │
    ▼ (if should_retrieve)
┌─────────────────────────────────┐
│ Query Builder                    │
│ └─ LLM 重寫查詢                  │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Tool Executor                    │
│ └─ retrieve_documents (漸進式)   │
│    ├─ 閾值 0.65 (高精度)         │
│    ├─ 閾值 0.50 (平衡)           │
│    └─ 閾值 0.35 (高召回)         │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Document Grader                  │
│ └─ LLM 評分相關性                │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Response Synth                   │
│ └─ LLM 生成最終回答              │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Telemetry                        │
│ └─ 記錄到 Langfuse               │
└─────────────────────────────────┘
```

## 設計原則

### 1. 關注點分離

- **API 層**：只處理 HTTP 相關邏輯
- **服務層**：業務邏輯，與 Web 框架無關
- **LLM 層**：模型呼叫和狀態管理

### 2. 依賴注入

服務透過單例模式初始化，便於測試時替換：

```python
from chatbot_rag.services.retriever_service import retriever_service
```

### 3. 配置驅動

所有行為可透過環境變數調整，無需修改程式碼：

```python
from chatbot_rag.core.config import settings
```

### 4. 可觀測性優先

- 每個請求有唯一 ID
- 所有 LLM 呼叫記錄到 Langfuse
- 中介軟體自動記錄效能指標

## 效能優化

| 優化項目 | 實現方式 | 效果 |
|----------|----------|------|
| JSON 序列化 | ORJSON | 2-3x 快 |
| 事件迴圈 | uvloop (可選) | 2-4x 快 |
| HTTP 解析 | httptools (可選) | ~10% 提升 |
| 向量搜尋 | Qdrant gRPC | 優於 REST |
| 對話壓縮 | 對話摘要 | 節省 Token |
| 檢索策略 | 漸進式閾值 | 早期終止 |

## 擴展點

1. **新增工具**：在 `agent_tools.py` 定義，自動被 `tool_executor` 使用
2. **自訂節點**：在 `graph/nodes/` 新增，修改 `factory.py` 整合
3. **新增評估器**：在 `evaluators.py` 定義，透過 Admin API 執行
4. **擴展 Prompt**：透過 Langfuse 管理，支援版本控制

## 相關文件

- [Agentic RAG 工作流程](./AGENTIC_RAG_FLOW.md)
- [SSE 串流處理](./SSE_STREAMING.md)
- [API 參考手冊](./API_REFERENCE.md)
